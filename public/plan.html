<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>This Week's Meals</title>
    <meta property="og:title" content="This Week's Meals">
    <meta property="og:description" content="Check out this week's meal plan!">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="This Week's Meals">
    <meta name="twitter:description" content="Check out this week's meal plan!">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Serif+Pro:wght@400;600;700&display=swap');

        :root {
            --primary-color: #2E7D32;
            --secondary-color: #666666;
            --light-grey: #F9F9F7;
            --dark-grey: #2C2C2C;
            --white: #ffffff;
            --border-color: #E8E8E8;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Source Serif Pro', serif;
            line-height: 1.6;
            background-color: var(--light-grey);
            color: var(--dark-grey);
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 40px;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2em;
            font-weight: 700;
            color: var(--dark-grey);
            letter-spacing: -0.02em;
            margin-bottom: 0.3em;
        }

        .subtitle {
            color: var(--secondary-color);
            font-size: 1em;
            margin-bottom: 2em;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 6rem;
        }

        .recipe-card {
            display: block;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 2px solid transparent;
        }

        .recipe-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: var(--primary-color);
        }

        .card-image {
            aspect-ratio: 4/3;
            overflow: hidden;
            background-color: var(--light-grey);
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            padding: 1rem;
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--dark-grey);
            margin: 0 0 0.25rem;
            letter-spacing: -0.01em;
        }

        .card-time {
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin: 0;
        }

        /* Loading / error states */
        .state-message {
            text-align: center;
            padding: 4rem 2rem;
        }

        .state-message h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5em;
            margin-bottom: 0.5em;
            color: var(--dark-grey);
        }

        .state-message p {
            color: var(--secondary-color);
            margin-bottom: 1.5em;
        }

        .state-message a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .state-message a:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none;
        }

        /* CTA bar */
        .cta-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }

        .cta-link {
            font-family: 'Source Serif Pro', serif;
            color: var(--white);
            background-color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            padding: 12px 32px;
            border-radius: var(--border-radius);
            display: inline-block;
            transition: background-color 0.2s;
        }

        .cta-link:hover {
            background-color: #1B5E20;
        }

        /* Mobile */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; margin: 10px auto; }
            h1 { font-size: 1.8em; }
            .recipe-grid { gap: 1rem; }
        }

        @media (max-width: 480px) {
            .recipe-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.75rem;
            }
            .card-body { padding: 0.75rem; }
            .card-title { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="page-title">This Week's Meals</h1>
            <p id="shared-by" class="subtitle"></p>
        </header>

        <div id="loading-state" class="state-message">
            <p>Loading meal plan...</p>
        </div>

        <div id="error-state" class="state-message hidden">
            <h2>Plan not found</h2>
            <p>This meal plan link has expired or doesn't exist.</p>
            <a href="/">Plan your own meals &rarr;</a>
        </div>

        <div id="recipe-grid" class="recipe-grid hidden">
        </div>
    </div>

    <div class="cta-bar" id="cta-bar" style="display:none">
        <a href="/" class="cta-link">Plan your own meals &rarr;</a>
    </div>

    <script>
        const DEFAULT_IMAGE = 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=400&q=80';

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        async function loadPlan() {
            const pathParts = window.location.pathname.split('/plan/');
            const shareId = pathParts[1];
            if (!shareId || !/^[A-Za-z0-9_-]{12}$/.test(shareId)) {
                showError();
                return;
            }

            try {
                const res = await fetch('/api/meal-plans/' + encodeURIComponent(shareId));
                if (!res.ok) { showError(); return; }
                const data = await res.json();
                renderPlan(data);
            } catch {
                showError();
            }
        }

        function renderPlan(data) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('recipe-grid').classList.remove('hidden');
            document.getElementById('cta-bar').style.display = '';

            // Subtitle
            const byEl = document.getElementById('shared-by');
            const dateStr = new Date(data.createdAt).toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            });
            const parts = [];
            if (data.createdBy) parts.push('Shared by ' + escapeHtml(data.createdBy));
            parts.push(dateStr);
            byEl.innerHTML = parts.join(' &middot; ');

            // Update page title
            if (data.createdBy) {
                document.title = data.createdBy + "'s Meal Plan";
            }

            // Recipe cards
            const grid = document.getElementById('recipe-grid');
            data.recipes.forEach(recipe => {
                const card = document.createElement('a');
                card.className = 'recipe-card';
                if (recipe.url) {
                    card.href = recipe.url;
                    card.target = '_blank';
                    card.rel = 'noopener noreferrer';
                } else {
                    card.removeAttribute('href');
                    card.style.cursor = 'default';
                }

                const img = document.createElement('img');
                img.src = recipe.image || DEFAULT_IMAGE;
                img.alt = recipe.name;
                img.onerror = function() { this.src = DEFAULT_IMAGE; };

                const imageDiv = document.createElement('div');
                imageDiv.className = 'card-image';
                imageDiv.appendChild(img);

                const title = document.createElement('h3');
                title.className = 'card-title';
                title.textContent = recipe.name;

                const body = document.createElement('div');
                body.className = 'card-body';
                body.appendChild(title);

                const timeParts = [];
                if (recipe.activeTime) timeParts.push(recipe.activeTime + ' active');
                if (recipe.totalTime) timeParts.push(recipe.totalTime + ' total');
                if (timeParts.length > 0) {
                    const timeEl = document.createElement('p');
                    timeEl.className = 'card-time';
                    timeEl.textContent = timeParts.join(' \u00B7 ');
                    body.appendChild(timeEl);
                }

                card.appendChild(imageDiv);
                card.appendChild(body);
                grid.appendChild(card);
            });
        }

        function showError() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }

        loadPlan();
    </script>
</body>
</html>
